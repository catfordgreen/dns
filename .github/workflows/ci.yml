name: ci

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  dns:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: gacts/install-dnscontrol@ab301885c91c9035d179099b0e8cef4e69ab4dd8 # v1.3.0

      - name: DNSControl check
        run: dnscontrol check

      - name: DNSControl preview
        id: preview
        if: ${{ github.repository == 'catfordgreen/dns' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          NO_COLOR: false
        run: |
          set -euo pipefail

          # Produce a machine-parseable report of proposed changes
          dnscontrol preview --report .dnscontrol-report.json

          # Derive an output flag "changed" based on the report
          # The report contains entries with a "changes" count per zone/provider.
          CHANGES=$(jq '[.[].corrections] | max' .dnscontrol-report.json)
          echo "Total proposed changes: ${CHANGES}"
          if [ "${CHANGES}" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: DNSControl push
        id: push
        if: ${{ github.repository == 'catfordgreen/dns' && github.event_name == 'push' && github.ref_name == 'main' && steps.preview.outputs.changed == 'true' }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          NO_COLOR: false
        run: dnscontrol push

      - name: Note why push was skipped
        if: ${{ steps.push.conclusion == 'skipped' }}
        run: |
          echo "ğŸš« DNSControl push was skipped."
          echo "ğŸ“¦ Event:    ${{ github.event_name }}"
          echo "ğŸŒ¿ Branch:   ${{ github.ref_name }}"
          echo "ğŸ“ Changed:  ${{ steps.preview.outputs.changed || 'n/a' }}"
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "ğŸ”‘ Secret:   âœ…"
          else
            echo "ğŸ”‘ Secret:   âŒ"
          fi